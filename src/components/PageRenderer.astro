---
import { getSection, initializeThemes } from '@lib/themeRegistry';

export interface Props {
  content: {
    theme: string;
    meta: {
      title: string;
      description: string;
      canonical?: string;
      image?: string;
      noindex?: boolean;
      structuredData?: object;
    };
    sections: Array<{
      type: string;
      data: any;
      settings?: any;
    }>;
    [key: string]: any;
  };
}

// Initialize themes on component load
await initializeThemes();

const { content } = Astro.props;
const { theme, meta, sections } = content;

// Load theme-specific layout - REQUIRED for each theme
let ThemeLayout: any = null;
try {
  const layoutModule = await import(`../themes/${theme}/layouts/ThemeLayout.astro`);
  ThemeLayout = layoutModule.default;
} catch (e) {
  throw new Error(`Theme "${theme}" must have a ThemeLayout.astro file in /themes/${theme}/layouts/`);
}

// Get all section components
const sectionComponents = sections.map(section => {
  const Component = getSection(theme, section.type);
  if (!Component) {
    console.error(`Failed to load section ${section.type} from theme ${theme}`);
    return null;
  }
  return { ...section, Component };
}).filter((section): section is NonNullable<typeof section> => section !== null);

// Props to pass to layout
const layoutProps = {
  ...meta,
  theme,
  content
};
---

<ThemeLayout {...layoutProps}>
  {sectionComponents.map((section) => {
    const { Component, data, settings } = section;
    return <Component data={data} settings={settings} />;
  })}
</ThemeLayout>